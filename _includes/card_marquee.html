{% comment %}
  Card Marquee Widget
  Usage: {% include card_marquee.html source="cards" %}
  Where _data/cards.yml contains your card data
{% endcomment %}

{% assign data_file = include.source | append: ".yml" %}
{% assign card_data = site.data[include.source].cards %}

<div class="card-marquee" id="card-marquee-{{ include.id | default: 'default' }}">
  <div class="card-marquee-track" data-card-width="335">
    {% for card in card_data %}
    <a href="{{ card.url | relative_url }}" class="card-marquee-item"{% if card.url contains 'http' %} target="_blank" rel="noopener noreferrer"{% endif %}>
      {% if card.thumb %}
      <div class="card-marquee-thumb">
        <img src="{{ card.thumb | relative_url }}" alt="{{ card.name }}">
      </div>
      {% endif %}
      <div class="card-marquee-content">
        {% if card.name %}
        <h4 class="card-marquee-name">{{ card.name }}</h4>
        {% endif %}
        {% if card.label %}
        <p class="card-marquee-label">{{ card.label }}</p>
        {% endif %}
        {% if card.description %}
        <p class="card-marquee-description">{{ card.description }}</p>
        {% endif %}
      </div>
    </a>
    {% endfor %}
  </div>
</div>

<script>
(function() {
  const marquees = document.querySelectorAll('.card-marquee');
  
  marquees.forEach(function(marquee) {
    const track = marquee.querySelector('.card-marquee-track');
    
    // Get original cards BEFORE cloning
    const originalCards = Array.from(track.querySelectorAll('.card-marquee-item'));
    const originalCount = originalCards.length;
    
    if (originalCount === 0) return;
    
    // Clone the original set exactly ONCE
    originalCards.forEach(function(card) {
      const clone = card.cloneNode(true);
      track.appendChild(clone);
    });
    
    // Force reflow to ensure everything is rendered
    void track.offsetWidth;
    
    // MEASURE the actual rendered width of the first set
    // This accounts for actual card width + gap as rendered by the browser
    const firstCard = originalCards[0];
    const lastCard = originalCards[originalCount - 1];
    
    // Get the actual positions
    const firstCardLeft = firstCard.offsetLeft;
    const lastCardRight = lastCard.offsetLeft + lastCard.offsetWidth;
    
    // Calculate the ACTUAL width of one complete set including the gap after the last card
    const computedStyle = window.getComputedStyle(track);
    const gap = parseFloat(computedStyle.gap) || 24;
    const singleSetWidth = (lastCardRight - firstCardLeft) + gap;
    
    // Set the scroll distance
    track.style.setProperty('--scroll-width', '-' + singleSetWidth + 'px');
    
    // Adjust animation duration for consistent speed
    const animationDuration = (singleSetWidth / 200).toFixed(1);
    
    // Start animation
    track.style.animation = 'scroll-left ' + animationDuration + 's linear infinite';
  });
})();
</script>